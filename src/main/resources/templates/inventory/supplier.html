<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{./common/thymeleafView::setContent(~{::.content})}">
    <div class="content">
        <div class="supplier-wrap">
            <div class="text-wrap">
                <p>공급업체내역</p>
                <p>❉ 조회 또는 수정을 원하시면 원하는 항목을 선택해주세요. </p>
            </div>
            <div class="supplier-title">
                <div class="filter-content">
                    <div class="filter-main">
                        <h3>상세내역검색</h3>
                        <button class="filter-button" type="submit" form="searchSuppliers">검색하기</button>
                        <button type="button" onclick="location.href='/inventory/supplierList'" class="filter-button">초기화</button>
                        <form action="supplierList" method="get" id="searchSuppliers" enctype="multipart/form-data">
                            <table>
                                <tr>
                                    <td><p>공급업체명</p></td>
                                    <td><input type="text" name="supplierName" th:value="${pageVO.cri.supplierName}"></td>
                                    <td><p>공급업체주소</p></td>
                                    <td><input type="text" name="supplierAddress" th:value="${pageVO.cri.supplierAddress}"></td>
                                    <td><p>공급업체사업자등록번호</p></td>
                                    <td><input type="text" name="supplierBusinessNo" th:value="${pageVO.cri.supplierBusinessNo}"></td>
                                </tr>
                                <tr>
                                    <td><p>담당자명</p></td>
                                    <td><input type="text" name="managerName" th:value="${pageVO.cri.managerName}"></td>
                                    <td><p>담당자 연락처</p></td>
                                    <td><input type="text" name="managerPhone" th:value="${pageVO.cri.managerPhone}"></td>
                                    <td><p>담당자 이메일</p></td>
                                    <td><input type="email" name="managerEmail" th:value="${pageVO.cri.managerEmail}"></td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>
            </div>

            <table id="supplierTable">
                <thead>
                <tr>
                    <th>공급업체번호</th>
                    <th>공급업체명</th>
                    <th>공급업체주소</th>
                    <th>공급업체 사업자등록번호</th>
                    <th>담당자명</th>
                    <th>담당자 연락처</th>
                    <th>담당자 이메일</th>
                    <th>첨부파일</th>
                </tr>
                </thead>
                <tbody>
                    <tr th:each="supplier : ${list}" th:data-supplier-no="${supplier.supplierNo}" class="supplier_list">
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.supplierNo}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.supplierName}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.supplierAddress}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.supplierBusinessNo}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.managerName}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.managerPhone}"></td>
                        <td th:onclick="'openModifyModal(' + ${supplier.supplierNo} + ')'" th:text="${supplier.managerEmail}"></td>
                        <td>
                            <a th:if="${supplier.supplierFile != null}"
                               th:href="@{/inventory/viewFile/{fileName}(fileName=${supplier.supplierFile})}"
                               target="_blank">조회
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="buttons">
                <div class="button-right">
                    <button type="button" class="register" onclick="checkRegister()">업체등록</button>
                </div>
            </div>

            <div class="center">
                <div class="page">
                    <th:block th:replace="~{./inventory/supplierPagination::page(${pageVO})}"></th:block>
                </div>
            </div>
        </div>

        <div id="popup-regist" class="popup-regist draggable-popup">
            <form action="registerSupplier" id="registerSupplier" method="post" enctype="multipart/form-data">
                <div class="popup-content">
                    <h2 class="drag-handle">공급업체 등록</h2>
                    <div class="popup-list">
                        <table>
                            <tbody>
                                <tr>
                                    <td><p>공급업체번호</p></td>
                                    <td><input type="text" name="supplierNo" disabled></td>
                                    <td><p>담당자명</p></td>
                                    <td><input type="text" name="managerName" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체명</p></td>
                                    <td><input type="text" name="supplierName" required></td>
                                    <td><p>담당자 연락처</p></td>
                                    <td><input type="text" name="managerPhone" pattern="\d{2,3}-\d{3,4}-\d{4}" placeholder="xx-xxxx-xxxx" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체주소</p></td>
                                    <td><input type="text" name="supplierAddress" required></td>
                                    <td><p>담당자 이메일</p></td>
                                    <td><input type="email" name="managerEmail" pattern="[a-zA-Z0-9]+[@][a-zA-Z0-9]+[.]+[a-zA-Z]+[.]*[a-zA-Z]*" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체 사업자등록번호</p></td>
                                    <td><input type="text" name="supplierBusinessNo" pattern="\d{3}-\d{2}-\d{5}" placeholder="xxx-xx-xxxx" required></td>
                                    <td><p>첨부파일</p></td>
                                    <td><input type="file" name="supplierFile" required></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="popup-button">
                        <div class="button-right">
                            <button type="submit" class="save" onclick="saveSupplier()">등록</button>
                            <button type="button" class="close" onclick="closeModal()">닫기</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="popup-modify" class="popup-modify draggable-popup">
            <form action="modifySupplier" id="modifySupplier" method="post" enctype="multipart/form-data">
                <div class="popup-content">
                    <h2 class="drag-handle">공급업체 수정</h2>
                    <div class="popup-list">
                        <table>
                            <tbody>
                                <tr>
                                    <td><p>공급업체번호</p></td>
                                    <td><input type="text" name="supplierNo" id="modifySupplierNo" readonly></td>
                                    <td><p>담당자명</p></td>
                                    <td><input type="text" name="managerName" id="modifyManagerName" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체명</p></td>
                                    <td><input type="text" name="supplierName" id="modifySupplierName" required></td>
                                    <td><p>담당자 연락처</p></td>
                                    <td><input type="text" name="managerPhone" id="modifyManagerPhone" pattern="\d{2,3}-\d{3,4}-\d{4}" placeholder="xx-xxxx-xxxx" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체주소</p></td>
                                    <td><input type="text" name="supplierAddress" id="modifySupplierAddress" required></td>
                                    <td><p>담당자 이메일</p></td>
                                    <td><input type="email" name="managerEmail" id="modifyManagerEmail" pattern="[a-zA-Z0-9]+[@][a-zA-Z0-9]+[.]+[a-zA-Z]+[.]*[a-zA-Z]*" required></td>
                                </tr>
                                <tr>
                                    <td><p>공급업체 사업자등록번호</p></td>
                                    <td><input type="text" name="supplierBusinessNo" id="modifySupplierBusinessNo" pattern="\d{3}-\d{2}-\d{5}" placeholder="xxx-xx-xxxx" required></td>
                                    <td><p>첨부파일</p></td>
                                    <td>
                                        <input type="file" name="supplierFile" id="modifySupplierFile">
                                        <input type="hidden" name="existingFile" id="existingFile">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="popup-button">
                        <div class="button-right">
                            <button type="button" class="modify" onclick="modifySupplier()">저장</button>
                            <button type="button" class="close" onclick="closeModal()">닫기</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</th:block>

<script>
    // 업체등록 팝업 열기
    function checkRegister() {
        document.getElementById("popup-regist").style.display = "flex";
    }

    // 공급업체의 정보 조회 후 수정 모달에 표시
    function openModifyModal(supplierNo) {
        fetch(`/inventory/getSupplierByNo/${supplierNo}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modifySupplierNo').value = data.supplierNo;
            document.getElementById('modifySupplierName').value = data.supplierName;
            document.getElementById('modifySupplierAddress').value = data.supplierAddress;
            document.getElementById('modifySupplierBusinessNo').value = data.supplierBusinessNo;
            document.getElementById('modifyManagerName').value = data.managerName;
            document.getElementById('modifyManagerPhone').value = data.managerPhone;
            document.getElementById('modifyManagerEmail').value = data.managerEmail;
            document.getElementById('existingFile').value = data.supplierFile;

            document.getElementById('popup-modify').style.display = "flex"; // 수정 모달창 열기
        })
        .catch(error => {
            alert('오류가 발생했습니다.');
        });
    }

    // 수정된 정보 서버로 전송 후 저장
    function modifySupplier() {
        const form = document.getElementById('modifySupplier');
        const formData = new FormData(form);

        // 파일이 변경되지 않았다면 기존 파일명을 사용
        if (formData.get('supplierFile').size === 0) {
            formData.delete('supplierFile');
            formData.append('supplierFile', formData.get('existingFile'));
        }

        fetch('/inventory/modifySupplier', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('성공적으로 수정되었습니다.');
                closeModal();
                updateTableRow(formData);
            }
            else {
                alert('수정에 실패했습니다: ' + data.message);
            }
        })
        .catch(error => {
            alert('오류가 발생했습니다: ' + error.message);
        });
    }

    // 테이블 행 업데이트
    function updateTableRow(formData) {
        const supplierNo = formData.get('supplierNo');
        const row = document.querySelector(`tr[data-supplier-no="${supplierNo}"]`);

        if (row) {
            row.cells[1].textContent = formData.get('supplierName');
            row.cells[2].textContent = formData.get('supplierAddress');
            row.cells[3].textContent = formData.get('supplierBusinessNo');
            row.cells[4].textContent = formData.get('managerName');
            row.cells[5].textContent = formData.get('managerPhone');
            row.cells[6].textContent = formData.get('managerEmail');

            // 파일 링크 업데이트
            const fileLink = row.cells[7].querySelector('a');
            if (fileLink) {
                const fileName = formData.get('supplierFile');
                if (fileName instanceof File) {
                    fileLink.href = `/inventory/viewFile/${fileName.name}`;
                } else {
                    fileLink.href = `/inventory/viewFile/${fileName}`;
                }
            }
        }
    }

    // 모달 닫기
    function closeModal() {
        document.getElementById("popup-regist").style.display = "none";
        document.getElementById("popup-modify").style.display = "none";
        document.getElementById("registerSupplier").reset();
        document.getElementById("modifySupplier").reset();
    }

    // 클릭 시 모달 닫기
    window.onclick = function(event) {
        if (event.target === document.getElementById('popup-regist') || event.target === document.getElementById('popup-modify')) {
            closeModal();
        }
    };

    // 페이지 로드 시 이벤트 리스너 추가
    document.addEventListener('DOMContentLoaded', function() {
        // 드래그 기능을 위한 스크립트
        ['popup-regist', 'popup-modify'].forEach(id => {
            const popup = document.getElementById(id);
            const dragHandle = popup.querySelector('h2');
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            dragHandle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            function startDrag(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = popup.offsetLeft;
                startTop = popup.offsetTop;
                popup.style.cursor = 'move';
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                let newX = startLeft + (e.clientX - startX);
                let newY = startTop + (e.clientY - startY);
                popup.style.left = newX + 'px';
                popup.style.top = newY + 'px';
            }

            function endDrag() {
                isDragging = false;
                popup.style.cursor = 'default';
            }
        });
    });


</script>

</body>
</html>