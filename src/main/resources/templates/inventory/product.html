<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script>
  window.onload = function () {
    // 드래그 기능을 추가할 팝업창 요소 선택
    const popupModify = document.getElementById('popup-modify');
    const popupRegist = document.getElementById('popup-regist');

    // 드래그 가능하게 만들기
    makeDraggable(popupModify);
    makeDraggable(popupRegist);
  };

  // 드래그 가능하게 하는 함수
  function makeDraggable(element) {
    let isDragging = false;
    let offsetX, offsetY;
    const header = element.querySelector('.popup-content');

    header.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - element.getBoundingClientRect().left;
      offsetY = e.clientY - element.getBoundingClientRect().top;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        element.style.left = `${e.clientX - offsetX}px`;
        element.style.top = `${e.clientY - offsetY}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }
</script>
<th:block th:replace="~{./common/thymeleafView::setContent(~{::.content})}">
  <div class="content">
    <div class="order-wrap">
      <div class="text-wrap">
        <p>상품조회</p>
        <p>❉ 조회 또는 수정을 원하시면 원하는 항목을 선택해주세요. </p>
      </div>
      <div class="order-title">
        <div class="filter-content">
          <form action="/inventory/productList" method="get">
            <div class="filter-main">
              <h3>상세내역검색</h3>
              <button type="submit" class="filter-button">검색하기</button>
              <button type="button" onclick="location.href='/inventory/productList'" class="filter-button">초기화</button>
            </div>
            <table>
              <tr>
                <td><p>카테고리</p></td>
                <td>
                  <select name="categoryNo">
                    <option value="0">- 카테고리 -</option>
                    <option th:each="categoryVO : ${categoryList}" th:value="${categoryVO.categoryNo}" th:text="${categoryVO.categoryName}" th:selected="${categoryVO.categoryNo == pageVO.cri.categoryNo}"></option>
                  </select>
                </td>
                <td><p>공급업체</p></td>
                <td>
                  <select name="supplierNo">
                    <option value="0">- 공급업체 -</option>
                    <option th:each="supplierVO : ${supplierList}" th:value="${supplierVO.supplierNo}" th:text="${supplierVO.supplierName}" th:selected="${supplierVO.supplierNo == pageVO.cri.supplierNo}"></option>
                  </select>
                </td>
                <td><p>상품명</p></td>
                <td><input type="text" name="productName" th:value="${pageVO.cri.productName}"></td>
              </tr>
              <tr>
                <td><p>판매가격</p></td>
                <td colspan="3"><input type="number" name="startProductPrice" th:value="${pageVO.cri.startProductPrice}" style="width: 44%; text-align: right;"> 원 ~ <input type="number" name="endProductPrice" th:value="${pageVO.cri.endProductPrice}" style="width: 44%; text-align: right;"> 원</td>
                <td><p>비고</p></td>
                <td>
                  <select name="productRemark">
                    <option value="">- 비고 -</option>
                    <option value="판매중" th:selected="${pageVO.cri.productRemark == '판매중'}">판매중</option>
                    <option value="품절" th:selected="${pageVO.cri.productRemark == '품절'}">품절</option>
                  </select>
                </td>
              </tr>
            </table>
          </form>
        </div>
      </div>

      <table id="productTable">
        <thead>
          <tr>
            <th>상품번호</th>
            <th>카테고리</th>
            <th>공급업체</th>
            <th>상품명</th>
            <!-- <th>상품설명</th> -->
            <th>판매가격</th>
            <th>상품이미지</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="productVO : ${productList}" class="product_list">
            <td th:text="${productVO.productNo}" onclick="handleClick(event)"></td>
            <td th:text="${productVO.categoryName}" onclick="handleClick(event)"></td>
            <td th:text="${productVO.supplierName}" onclick="handleClick(event)"></td>
            <td th:text="${productVO.productName}" onclick="handleClick(event)"></td>
            <!-- <td th:text="${vo.productContent}"></td> -->
            <td th:text="${productVO.productPrice}" onclick="handleClick(event)"></td>
            <td><a th:href="@{/inventory/displayImg/{productImg}(productImg=${productVO.productImg})}" target="_blank">조회</td>
            <td th:text="${productVO.productRemark}" onclick="handleClick(event)"></td>
          </tr>
        </tbody>
      </table>

      <div class="buttons">
        <div class="button-left"></div>
        <button class="button-regist button-right" onclick="handleClick2(this.innerHTML)">상품 등록</button>
      </div>

      <div class="center">
        <div class="page">
          <th:block th:replace="~{./inventory/productPagination::page(${pageVO})}"></th:block>
        </div>
      </div>
    </div>


    <!-- 등록 팝업 -->
    <div id="popup-regist" class="popup-regist">
      <form action="/inventory/postProduct" method="post" enctype="multipart/form-data" id="postProductForm">
        <div class="popup-content">
          <h2>상품등록</h2>
          <div class="popup-list">
            <table>
              <tbody>
                <tr>
                  <td><p>공급업체</p></td>
                  <td><select name="supplierNo" id="postSupplierNo" onchange="changeSupplierNo(event)"></select></td>
                  <td><p>사업자번호</p></td>
                  <td><input type="text" id="postSupplierBusinessNo" disabled style="background-color: #e3e3e3;"></td>
                </tr>
                <tr>
                  <td><p>담당자</p></td>
                  <td><input type="text" id="postManagerName" disabled style="background-color: #e3e3e3;"></td>
                  <td><p>담당자 연락처</p></td>
                  <td><input type="text" id="postManagerPhone" disabled style="background-color: #e3e3e3;"></td>
                </tr>
                <tr>
                  <td><p>카테고리</p></td>
                  <td><select name="categoryNo" id="postCategoryNo"></select></td>
                  <td><p>판매상태</p></td>
                  <td colspan="3">
                    <select name="productRemark" id="postProductRemark">
                      <option value="">- 판매상태 -</option>
                      <option value="판매중">판매중</option>
                      <option value="품절">품절</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td><p>상품명</p></td>
                  <td><input type="text" name="productName" id="postProductName"></td>
                  <td><p>판매정가</p></td>
                  <td><input type="text" name="productPrice" id="postProductPrice"></td>
                </tr>
                <tr>
                  <td><p>안전재고수량</p></td>
                  <td><input type="text" name="safetyQuantity" id="postSafetyQuantity"></td>
                  <td><p>상품이미지</p></td>
                  <td><input type="file" name="file" id="postProductImg"></td>
                </tr>
                <tr>
                  <td><p>상품설명</p></td>
                  <td colspan="3"><textarea rows="4" name="productContent" id="postProductContent"></textarea></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="popup-button">
            <div class="button-left">
            </div>
            <div class="button-right">
              <button type="button" onclick="postProductFn()">등록</button>
              <button type="button" class="close-btn2">닫기</button>
            </div>
          </div>
        </div>
      </form>
    </div>


    <!-- 수정 팝업 -->
    <div id="popup-modify" class="popup-modify">
      <form action="/inventory/putProduct" method="post" enctype="multipart/form-data">
        <input type="hidden" name="productNo" id="putProductNo">
        <input type="hidden" name="supplierNo" id="putSupplierNo">
        <div class="popup-content">
          <h2>상품수정</h2>
          <div class="popup-list">
            <table>
              <tbody>
              <tr>
                <td><p>공급업체</p></td>
                <td><input type="text" id="putSupplierName" disabled style="background-color: #e3e3e3;"></td>
                <td><p>사업자번호</p></td>
                <td><input type="text" id="putSupplierBusinessNo" disabled style="background-color: #e3e3e3;"></td>
              </tr>
              <tr>
                <td><p>담당자</p></td>
                <td><input type="text" id="putManagerName" disabled style="background-color: #e3e3e3;"></td>
                <td><p>담당자 연락처</p></td>
                <td><input type="text" id="putManagerPhone" disabled style="background-color: #e3e3e3;"></td>
              </tr>
              <tr>
                <td><p>카테고리</p></td>
                <td><select name="categoryNo" id="putCategoryNo"></select></td>
                <td><p>판매상태</p></td>
                <td colspan="3">
                  <select name="productRemark" id="putProductRemark">
                    <option value="">- 판매상태 -</option>
                    <option value="판매중">판매중</option>
                    <option value="품절">품절</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><p>상품명</p></td>
                <td><input type="text" name="productName" id="putProductName"></td>
                <td><p>판매정가</p></td>
                <td><input type="text" name="productPrice" id="putProductPrice"></td>
              </tr>
              <tr>
                <td><p>안전재고수량</p></td>
                <td><input type="text" name="safetyQuantity" id="putSafetyQuantity"></td>
                <td><p>상품이미지</p></td>
                <td><input type="file" name="file" id="putProductImg"></td>
              </tr>
              <tr>
                <td><p>상품설명</p></td>
                <td colspan="3"><textarea rows="4" name="productContent" id="putProductContent"></textarea></td>
              </tr>
              </tbody>
            </table>
          </div>
          <div class="popup-button">
            <div class="button-left">
            </div>
            <div class="button-right">
              <button type="submit">수정</button>
              <button type="button" class="close-btn3">닫기</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</th:block>

<script>
  //팝업창 열기 및 닫기 기능
  const resistPopup = document.getElementById('popup-regist');
  const modifyPopup = document.getElementById('popup-modify');
  const closeRegistPopup = document.querySelector('.close-btn2');
  const closeModifyPopup = document.querySelector('.close-btn3');

  //팝업창 열기
  function handleClick2(tdValue) { //등록페이지 팝업 열기
    $.ajax({
      url: '/inventory/getSupplierList',
      type: 'get',
      dataType: 'json',
      success: function(data) {
        var html = '<option value=' + 0 + '>- 공급업체 -</option>';
        $.each(data, function(index, obj) {
          html += '<option value=' + obj.supplierNo + '>' + obj.supplierName + '</option>';
        });
        $('#postSupplierNo').html(html);
      },
      error: function() {
        alert('error');
      }
    });

    $.ajax({
      url: '/inventory/getCategoryList',
      type: 'get',
      dataType: 'json',
      success: function(data) {
        var html = '<option value=' + 0 + '>- 카테고리 -</option>';
        $.each(data, function(index, obj) {
          html += '<option value=' + obj.categoryNo + '>' + obj.categoryName + '</option>';
        });
        $('#postCategoryNo').html(html);
      },
      error: function() {
        alert('error');
      }
    });
    resistPopup.style.display = 'block';
  }

  function changeSupplierNo(event) {
    $.ajax({
      url: '/inventory/getSupplierContent',
      type: 'get',
      data: {supplierNo : event.target.value},
      dataType: 'json',
      success: function(data) {
        $('#postSupplierNo').val(data.supplierNo);
        $('#postSupplierBusinessNo').val(data.supplierBusinessNo);
        $('#postManagerName').val(data.managerName);
        $('#postManagerPhone').val(data.managerPhone);
        $('#postCategoryNo').val('0').prop('selected', true);
        $('#postProductName').val('');
        $('#postProductPrice').val('');
        $('#postSafetyQuantity').val('');
        $('#postProductImg').val('');
        $('#postProductContent').val('');
        $('#postProductRemark').val('').prop('selected', true);
      },
      error: function() {
        $('#postSupplierNo').val('0').prop('selected', true);
        $('#postSupplierBusinessNo').val('');
        $('#postManagerName').val('');
        $('#postManagerPhone').val('');
        $('#postCategoryNo').val('0').prop('selected', true);
        $('#postProductName').val('');
        $('#postProductPrice').val('');
        $('#postSafetyQuantity').val('');
        $('#postProductImg').val('');
        $('#postProductContent').val('');
        $('#postProductRemark').val('').prop('selected', true);
      }
    });
  }

  function postProductFn() {
    if($('#postSupplierNo').val() == 0) {
      alert('공급업체를 선택해주세요.');
      return;
    }
    if($('#postCategoryNo').val() == 0) {
      alert('카테고리를 선택해주세요.');
      return;
    }
    if($('#postProductRemark').val() == '') {
      alert('판매상태를 선택해주세요.');
      return;
    }
    if($('#postProductRemark').val() == '') {
      alert('판매상태를 선택해주세요.');
      return;
    }
    if($('#postProductName').val() == '') {
      alert('상품명을 입력해주세요.');
      return;
    }
    if($('#postProductPrice').val() == '') {
      alert('판매정가를 입력해주세요.');
      return;
    }
    if($('#postSafetyQuantity').val() == '') {
      alert('안전재고수량을 입력해주세요.');
      return;
    }
    if($('#postProductImg').val() == '') {
      alert('상품이미지를 업로드해주세요.');
      return;
    }

    $('#postProductForm').submit();
  }

  function handleClick(event) { //수정페이지 팝업 열기
    $.ajax({
      url: '/inventory/getCategoryList',
      type: 'get',
      dataType: 'json',
      success: function(data) {
        var html = '<option value=' + 0 + '>- 카테고리 -</option>';
        $.each(data, function(index, obj) {
          html += '<option value=' + obj.categoryNo + '>' + obj.categoryName + '</option>';
        });
        $('#putCategoryNo').html(html);
      },
      error: function() {
        alert('getCategoryList error');
      }
    });

    $.ajax({
      url: '/inventory/getProductContent',
      type: 'get',
      data: {productNo : event.target.parentElement.children[0].innerText},
      dataType: 'json',
      success: function(data) {
        $('#putProductNo').val(data.productNo);
        $('#putSupplierNo').val(data.supplierNo);
        $('#putSupplierName').val(data.supplierName);
        $('#putSupplierBusinessNo').val(data.supplierBusinessNo);
        $('#putManagerName').val(data.managerName);
        $('#putManagerPhone').val(data.managerPhone);
        $('#putCategoryNo').val(data.categoryNo).prop('selected', true);
        $('#putProductName').val(data.productName);
        $('#putProductPrice').val(data.productPrice);
        $('#putSafetyQuantity').val(data.safetyQuantity);
        //$('#putProductImg').val(data.productImg);
        $('#putProductContent').val(data.productContent);
        $('#putProductRemark').val(data.productRemark);
      },
      error: function() {
        alert('getProductContent error');
      }
    });
    modifyPopup.style.display = 'block';
  }

  //팝업창 닫기
  function closePopupRegist() {
      resistPopup.style.display = 'none'; //등록페이지 팝업 닫기
  }

  function closePopupModify() {
      modifyPopup.style.display = 'none'; //수정페이지 팝업 닫기
  }

  // 닫기 버튼 클릭 시 팝업창 닫기
  closeRegistPopup.addEventListener('click', closePopupRegist); //--- 닫기 버튼
  closeModifyPopup.addEventListener('click', closePopupModify); //--- 닫기 버튼
</script>
</html>